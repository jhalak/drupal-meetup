<?php
/**
 * @author - Jhalak
 */

require_once 'NodeSessionQuery.inc';

function entityfieldquery_menu(){
  return array(
    'sessions' => array(
      'title' => t('Sessions'),
      'page callback' => 'entityfieldquery_list',
      'access arguments' => array('access content'),
    )
  );
}

/**
 * callback function
 */
function entityfieldquery_list(){
  entityfieldquery_list_with_db_select();
  entityfieldquery_list_normal();
  entityfieldquery_list_extends();
}

function entityfieldquery_list_with_db_select(){
  $query = db_select('node', 'n');
  $query->fields('n', array('nid'));
  $query->join('field_data_field_speaker', 's', 's.entity_id = n.nid');
  $query->condition('type', 'session', '=');
  $query->condition('s.field_speaker_value', 'Jhalak', '=');
  $result = $query->execute();

  if ($result->rowCount() <= 0) {
    return t('No entry found.');
  }
  $nodes = array();
  while($record = $result->fetchAssoc()) {
    $nodes[] = $record['nid'];
  }
  return _entityfieldquery_generate_teasure_view($nodes);
}

function entityfieldquery_list_normal() {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', array('session'))
    ->fieldCondition('field_speaker', 'value', 'Jhalak', '=');
  $result = $query->execute();
  return _entityfieldquery_generate_output_from_result($result);
}


function entityfieldquery_list_extends() {
  $query = new NodeSessionQuery();
  $query->fieldCondition('field_speaker', 'value', 'Jhalak', '=');
  $result = $query->execute();
  return _entityfieldquery_generate_output_from_result($result);
}

function _entityfieldquery_generate_output_from_result($result) {
  if (empty($result['node'])) {
    return t('No entry found.');
  }
  $nodes = array_keys($result['node']);
  return _entityfieldquery_generate_teasure_view($nodes);
}

function _entityfieldquery_generate_teasure_view($nodes) {
  return node_view_multiple(node_load_multiple($nodes));
}

function dump($var){
  echo '<pre>';
  print_r($var);
  exit;
}